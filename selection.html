<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title id="docTitle">Selection Letter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{ margin:0; padding:0; background:#dcdcdc; font-family:"Times New Roman", serif; }

/* A4 Sheet Layout */
.letter{
  width:210mm; height:297mm; margin:15mm auto; background:#e6e3d9; 
  position:relative; box-sizing:border-box; padding:18mm;
}

/* INNER PAGE BORDER */
.inner-border{ position:absolute; top:14mm; left:14mm; right:14mm; bottom:14mm; pointer-events:none; }
.inner-border::before{ content:""; position:absolute; top:0; left:0; right:0; bottom:0; border:2px solid #000; }
.inner-border::after{ content:""; position:absolute; top:2mm; left:2mm; right:2mm; bottom:2mm; border:1.5px solid #000; }

/* WATERMARK */
.watermark{
  position:absolute; inset:0; top:10%; bottom:30%; 
  background:url("watermark.png") center center no-repeat;
  background-size:520px; opacity:0.20; z-index:1;
}

.email-btn{ position:fixed; top:60px; right:15px; padding:10px 18px; background:#1a4cff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; z-index:100; }
.print-btn{ position:fixed; top:15px; right:15px; padding:10px 18px; background:#000; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; z-index:100; }

@media print{
  .email-btn, .print-btn{ display:none; }
  @page{ size:A4; margin:0; }
  body{ background:#fff; }
  .letter{ margin:0; }
}

.content{ position:relative; z-index:2; font-size:16px; line-height:1.7; }
h1{ text-align:center; font-size:28px; letter-spacing:1.5px; text-decoration:underline; margin:0 0 10px 0; }
.heading{ font-weight:bold; text-decoration:underline; margin-top:10px; }
p{ margin:6px 0 6px 8px; text-align:justify; }
.footer{ margin-top:50px; text-align:right; }
.map-link{ color:#000; text-decoration:underline; font-weight:bold; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>

<body>

<button class="print-btn" onclick="window.print()">üñ® Print Letter</button>
<button class="email-btn" onclick="sendEmail()">‚úâ Send PDF via Email</button>

<div class="letter">
  <div class="inner-border"></div>
  <div class="watermark"></div>

  <div class="content">
    <h1>SELECTION LETTER</h1>

    <div class="heading">TO:</div>
    <p>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><span id="name"></span></b><br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="district"></span><br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ph No: <span id="phone"></span><br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Register No: <span id="regNo"></span>
    </p>

    <div class="heading">RESPECTED SIR / MADAM,</div>
    <p>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This is to inform you that the documents submitted by you for work purposes
      have been successfully verified. Based on the verification, you have been
      selected for <strong>Training and Interview</strong> at
      <strong>V Believers Marketing Pvt Ltd</strong>.
    </p>

    <p>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Your dedication and commitment are highly appreciated. We believe your
      professional skills will add strategic value to our organization.
    </p>

    <div class="heading">Training Details</div>
    <p>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Training Start Date: <span id="circleDate"></span><br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reporting Time: 9:30 AM onwards<br>
      &nbsp;&nbsp;&nbsp;&nbsp;<b><u>Note:</u> Please verify your documents before the training day and if you want food & accommodation you need to take membership.</b>
    </p>

    <div class="heading">Documents to be Submitted (Xerox copies only)</div>
    <p>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ Aadhar Card<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ PAN Card<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ Education Certificates<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ Bank Passbook<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ Two Passport Size Photos
    </p>

    <div class="heading">Training Location</div>
    <p>
      <a id="mapLink" class="map-link" target="_blank">View on Google Maps</a>
    </p>

    <div class="footer">
      Kindly ensure timely reporting with all required documents.<br><br>
      Warm Regards,<br>
      <strong>HR Department</strong><br>
      V Believers Marketing Pvt Ltd<br>
      7075110436
    </div>
  </div>
</div>

<script>
// 1. Load data automatically when the page opens
window.onload = function() {
    let data = {};
    try {
        const dataStr = localStorage.getItem("letterData");
        if (dataStr) {
            data = JSON.parse(dataStr);
        }
    } catch (e) {
        console.error("Invalid letterData in localStorage", e);
    }

    document.getElementById("regNo").textContent = data.regNo || "";
    document.getElementById("name").textContent = data.name || "Applicant Name";
    document.getElementById("docTitle").textContent = (data.name || "Applicant") + " - Selection Letter";
    document.getElementById("district").textContent = data.district || "District";
    document.getElementById("phone").textContent = data.phone || "Phone Number";
    document.getElementById("circleDate").textContent = data.circleDate || "DD/MM/YYYY";
    window.currentEmail = data.email || null;
};

// 2. Generate PDF and Send via API
async function sendEmail() {
    const btn = document.querySelector(".email-btn");
    
    if (!window.currentEmail) {
        alert("‚ùå Error: No email found for this applicant.");
        return;
    }

    btn.innerText = "‚è≥ Generating PDF...";
    btn.disabled = true;

    try {
        const { jsPDF } = window.jspdf;
        const element = document.querySelector(".letter");

        const canvas = await html2canvas(element, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/jpeg',0.7);

        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
        const pdfBase64 = pdf.output('datauristring');

        const name = document.getElementById("name").innerText;
        
        const response = await fetch('/api/send-mail', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: window.currentEmail,
                name: name,
                pdfData: pdfBase64
            })
        });

        if (response.ok) {
            alert("‚úÖ Success! Letter sent to " + window.currentEmail);
        } else {
            let msg = "Check server logs";
            try {
                const errorData = await response.json();
                msg = errorData.error || msg;
            } catch (e) {}
            alert("‚ùå Failed: " + msg);
        }
    } catch (err) {
        console.error(err);
        alert("‚ùå Error: Could not connect to the server.");
    } finally {
        btn.innerText = "‚úâ Send PDF via Email";
        btn.disabled = false;
    }
}
</script>

</body>
</html>



