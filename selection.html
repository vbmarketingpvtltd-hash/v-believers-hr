<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title id="docTitle">Selection Letter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{ margin:0; padding:0; background:#dcdcdc; font-family:"Times New Roman", serif; }
.letter{ width:210mm; height:297mm; margin:15mm auto; background:#e6e3d9; position:relative; box-sizing:border-box; padding:18mm; }
.inner-border{ position:absolute; top:14mm; left:14mm; right:14mm; bottom:14mm; pointer-events:none; }
.inner-border::before{ content:""; position:absolute; inset:0; border:2px solid #000; }
.inner-border::after{ content:""; position:absolute; inset:2mm; border:1.5px solid #000; }
.watermark{ position:absolute; inset:0; top:10%; bottom:30%; background:url("watermark.png") center no-repeat; background-size:520px; opacity:0.20; z-index:1; }
.email-btn{ position:fixed; top:60px; right:15px; padding:10px 18px; background:#1a4cff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; z-index:100; }
.print-btn{ position:fixed; top:15px; right:15px; padding:10px 18px; background:#000; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; z-index:100; }

@media print{
  .email-btn, .print-btn{ display:none; }
  @page{ size:A4; margin:0; }
  body{ background:#fff; }
  .letter{ margin:0; }
}

.content{ position:relative; z-index:2; font-size:16px; line-height:1.7; }
h1{ text-align:center; font-size:28px; text-decoration:underline; margin-bottom:10px; }
.heading{ font-weight:bold; text-decoration:underline; margin-top:10px; }
p{ margin:6px 0 6px 8px; text-align:justify; }
.footer{ margin-top:50px; text-align:right; }
.map-link{ color:#000; text-decoration:underline; font-weight:bold; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>

<body>

<button class="print-btn" onclick="window.print()">üñ® Print Letter</button>
<button class="email-btn" onclick="sendEmail()">‚úâ Send PDF via Email</button>

<div class="letter">
  <div class="inner-border"></div>
  <div class="watermark"></div>

  <div class="content">
    <h1>SELECTION LETTER</h1>

    <div class="heading">TO:</div>
    <p>
      <b><span id="name"></span></b><br>
      <span id="district"></span><br>
      Ph No: <span id="phone"></span><br>
      Register No: <span id="regNo"></span>
    </p>

    <div class="heading">RESPECTED SIR / MADAM,</div>
    <p>
      This is to inform you that the documents submitted by you have been verified.
      You are selected for <strong>Training and Interview</strong> at
      <strong>V Believers Marketing Pvt Ltd</strong>.
    </p>

    <div class="heading">Training Details</div>
    <p>
      Training Start Date: <span id="circleDate"></span><br>
      Reporting Time: 9:30 AM onwards
    </p>

    <div class="footer">
      Warm Regards,<br>
      <strong>HR Department</strong><br>
      V Believers Marketing Pvt Ltd
    </div>
  </div>
</div>

<script>
window.onload = function () {
  const dataStr = localStorage.getItem("letterData");
  if (!dataStr) return;

  const data = JSON.parse(dataStr);
  document.getElementById("regNo").textContent = data.regNo || "";
  document.getElementById("name").textContent = data.name || "";
  document.getElementById("district").textContent = data.district || "";
  document.getElementById("phone").textContent = data.phone || "";
  document.getElementById("circleDate").textContent = data.circleDate || "";
  document.getElementById("docTitle").textContent = `${data.name} - Selection Letter`;
  window.currentEmail = data.email;
};

async function sendEmail() {
  const btn = document.querySelector(".email-btn");

  if (!window.currentEmail) {
    alert("‚ùå No email found.");
    return;
  }

  btn.innerText = "‚è≥ Sending...";
  btn.disabled = true;

  try {
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.querySelector(".letter"), { scale: 2 });
    const imgData = canvas.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    pdf.addImage(imgData, "PNG", 0, 0, 210, 297);
    const pdfBase64 = pdf.output("datauristring");

    const response = await fetch("/api/send-mail", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: window.currentEmail,
        name: document.getElementById("name").innerText,
        pdfData: pdfBase64
      })
    });

    if (!response.ok) {
      const text = await response.text();   // ‚úÖ SAFE
      alert("‚ùå Failed: " + (text || "Server error"));
      return;
    }

    const data = await response.json();
    alert("‚úÖ " + data.message);

  } catch (err) {
    console.error(err);
    alert("‚ùå Could not connect to server");
  } finally {
    btn.innerText = "‚úâ Send PDF via Email";
    btn.disabled = false;
  }
}
</script>

</body>
</html>
